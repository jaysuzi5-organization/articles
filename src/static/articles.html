<!DOCTYPE html>
<html>
<head>
  <title>Articles Test Page</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <h1>Articles Management</h1>
  <h2>Add Article</h2>

  <form id="articlesForm" autocomplete="off">
    <label>
      Title:
      <input type="text" id="title" required>
    </label>
    <label>
      Link:
      <input type="url" id="link" required>
    </label>
    <label>
      Summary:
      <textarea id="summary" required></textarea>
    </label>
    <label>
      Reasons:
      <textarea id="reasons" required></textarea>
    </label>
    <label>
      Tags:
      <input type="text" id="tags" required>
    </label>
    <label>
      Relevancy Score:
      <input type="number" id="relevancy_score" required>
    </label>
    <label>
      Urgency Score:
      <input type="number" id="urgency_score" required>
    </label>
    <label>
      Overall Score:
      <input type="number" id="overall_score" required>
    </label>
    <label>
      Input Cost:
      <input type="number" step="0.0001" id="input_cost" required>
    </label>
    <label>
      Output Cost:
      <input type="number" step="0.0001" id="output_cost" required>
    </label>
    <label>
      Total Cost:
      <input type="number" step="0.0001" id="total_cost" required>
    </label>
    <label>
      Model:
      <input type="text" id="model" required>
    </label>
    <button type="submit">Add</button>
  </form>
  <div id="responseMessage"></div>

  <h2>Articles List</h2>

  <!-- Days back filter -->
  <div id="daysBackControls" style="margin-bottom: 1rem;">
    <label for="daysBackInput" style="font-weight:600; font-size:0.9rem; color: var(--blue-dark);">
      Days back:
    </label>
    <input type="number" id="daysBackInput" min="1" value="1" style="width:70px;">
  </div>

  <!-- Pagination Controls -->
  <div id="paginationControls" aria-label="Pagination controls">
    <button id="prevPage" disabled>Previous</button>
    <span>Page <span id="currentPage">1</span></span>
    <button id="nextPage">Next</button>
    <label for="pageSizeSelect" style="margin-left: auto; font-weight:600; font-size:0.9rem; color: var(--blue-dark);">
      Items per page:
    </label>
    <select id="pageSizeSelect" aria-label="Select number of items per page">
      <option value="5">5</option>
      <option value="10" selected>10</option>
      <option value="20">20</option>
      <option value="50">50</option>
    </select>
  </div>

  <table id="articlesTable" aria-label="articles list table">
    <thead>
      <tr>
        <th>Article ID</th>
        <th>Title</th>
        <th>Summary</th>
        <th>Link</th>
        <th>Tags</th>
        <th>Relevancy</th>
        <th>Urgency</th>
        <th>Total Score</th>
        <th>Total Cost</th>
        <th>Model</th>
        <th>Create Date</th>
        <th>Update Date</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

<script>
  const apiBase = '/api/v1/articles';
  const responseMessage = document.getElementById('responseMessage');
  const tbody = document.querySelector('#articlesTable tbody');
  const currentPageSpan = document.getElementById('currentPage');
  const prevPageBtn = document.getElementById('prevPage');
  const nextPageBtn = document.getElementById('nextPage');
  const pageSizeSelect = document.getElementById('pageSizeSelect');
  const tableHeaders = document.querySelectorAll('#articlesTable thead th');
  const daysBackInput = document.getElementById('daysBackInput');

  let currentPage = 1;
  let sortBy = 'create_date';   // default sort column
  let sortOrder = 'desc';       // default order
  let daysBack = Number(daysBackInput.value) || 1;

  function getPageSize() {
    return Number(pageSizeSelect.value);
  }

  daysBackInput.addEventListener('change', () => {
    if (daysBackInput.value < 1) {
      daysBackInput.value = 1;
    }
    currentPage = 1;
    load_articles(currentPage);
  });


  async function load_articles(page = 1) {
    responseMessage.textContent = '';
    responseMessage.className = '';

    const pageSize = getPageSize();
    daysBack = Number(daysBackInput.value) || 1;

    try {
      const res = await fetch(
        `${apiBase}?page=${page}&limit=${pageSize}&sort_by=${sortBy}&sort_order=${sortOrder}&days_back=${daysBack}`
      );
      if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);

      const data = await res.json();
      tbody.innerHTML = '';

      if (data.length === 0 && page > 1) {
        currentPage = page - 1;
        updatePaginationButtons();
        load_articles(currentPage);
        return;
      }
      data.forEach(article => {
        const isHot = article.overall_score >= 8;
        tbody.innerHTML += `
          <tr>
            <td>${article.article_id}</td>
            <td class="title-col">${article.title}</td>
            <td class="summary-col">${article.summary}</td>
            <td><a href="${article.link}" target="_blank">${article.link}</a></td>
            <td>${article.tags}</td>
            <td>${article.relevancy_score}</td>
            <td>${article.urgency_score}</td>
            <td>
              ${article.overall_score}
              ${isHot ? '<span class="hot-icon" title="Hot">ðŸ”¥</span>' : ''}
            </td>
            <td>${Number(article.total_cost).toFixed(4)}</td>
            <td>${article.model}</td>
            <td>${article.create_date ? new Date(article.create_date).toLocaleString() : ''}</td>
            <td>${article.update_date ? new Date(article.update_date).toLocaleString() : ''}</td>
          </tr>
        `;
      });

      currentPage = page;
      currentPageSpan.textContent = currentPage;
      updatePaginationButtons();
    } catch (err) {
      responseMessage.textContent = 'Failed to load articles: ' + err.message;
      responseMessage.classList.add('error');
    }
  }

  function updatePaginationButtons() {
    prevPageBtn.disabled = currentPage <= 1;
  }

  // Pagination
  prevPageBtn.addEventListener('click', () => {
    if (currentPage > 1) load_articles(currentPage - 1);
  });

  nextPageBtn.addEventListener('click', () => {
    load_articles(currentPage + 1);
  });

  pageSizeSelect.addEventListener('change', () => {
    currentPage = 1;
    load_articles(currentPage);
  });

  // Sorting
  tableHeaders.forEach((th, index) => {
    th.style.cursor = "pointer";
    th.addEventListener('click', () => {
      const columnMap = [
        'article_id', 'title', 'summary', 'link', 'tags',
        'relevancy_score', 'urgency_score', 'overall_score',
        'total_cost', 'model', 'create_date', 'update_date'
      ];

      const clickedColumn = columnMap[index];
      if (sortBy === clickedColumn) {
        // toggle order
        sortOrder = sortOrder === 'asc' ? 'desc' : 'asc';
      } else {
        sortBy = clickedColumn;
        sortOrder = 'asc';
      }

      load_articles(currentPage);
    });
  });

  // Form submission
  document.getElementById('articlesForm').addEventListener('submit', e => {
    e.preventDefault();
    responseMessage.textContent = '';
    responseMessage.className = '';

    const article = {
      title: document.getElementById('title').value.trim(),
      link: document.getElementById('link').value.trim(),
      summary: document.getElementById('summary').value.trim(),
      reasons: document.getElementById('reasons').value.trim(),
      tags: document.getElementById('tags').value.trim(),
      relevancy_score: Number(document.getElementById('relevancy_score').value),
      urgency_score: Number(document.getElementById('urgency_score').value),
      overall_score: Number(document.getElementById('overall_score').value),
      input_cost: Number(document.getElementById('input_cost').value),
      output_cost: Number(document.getElementById('output_cost').value),
      total_cost: Number(document.getElementById('total_cost').value),
      model: document.getElementById('model').value.trim()
    };

    fetch(apiBase, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(article)
    })
    .then(async res => {
      const contentType = res.headers.get('content-type') || '';
      let data = contentType.includes('application/json') ? await res.json() : await res.text();

      if (res.status >= 400) {
        responseMessage.textContent = `Error ${res.status}: ` + (typeof data === 'string' ? data : JSON.stringify(data));
        responseMessage.classList.add('error');
      } else {
        responseMessage.textContent = `Success ${res.status}: Article added.`;
        responseMessage.classList.add('success');
        document.getElementById('articlesForm').reset();
        load_articles(currentPage);
      }
    })
    .catch(err => {
      responseMessage.textContent = 'Network or server error: ' + err.message;
      responseMessage.classList.add('error');
    });
  });

  load_articles(currentPage);
</script>

</body>
</html>
